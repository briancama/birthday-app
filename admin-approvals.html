<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Admin Approvals - Birthday Challenge Zone</title>
    <link rel="icon" type="image/png" href="images/favicon.jpg" />
    <link rel="stylesheet" href="css/geocities.css" />
    <link rel="stylesheet" href="css/components/navigation.css" />
    <link rel="stylesheet" href="css/components/forms.css" />
    <link rel="stylesheet" href="css/components/submissions.css" />
    <link rel="stylesheet" href="css/components/contest-placements.css" />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
  </head>

  <body>
    <div class="container">
      <!-- Navigation Component -->
      <nav class="site-navigation">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" data-sound="menu" aria-label="Toggle navigation menu">
          <span class="hamburger-icon">‚ò∞</span>
        </button>

        <!-- Page Title / User Info -->
        <div class="nav-user-info">
          <div class="user-welcome">
            <img src="images/star_icon.gif" alt="star" class="icon-gif hide-mobile" />
            <span data-nav="page-title">Admin Approvals</span>
            <img src="images/star_icon.gif" alt="star" class="icon-gif" />
          </div>
        </div>

        <!-- Navigation Menu (closed by default) -->
        <div class="nav-menu">
          <div class="nav-tabs">
            <a href="dashboard" class="nav-tab" data-sound="menu" data-page="dashboard">
              <img
                src="images/home.gif"
                alt="home"
                class="icon-gif icon-gif--lg icon-gif--with-text"
              />
              <span>DASHBOARD</span>
            </a>
            <a href="event-info" class="nav-tab active" data-sound="menu" data-page="event-info">
              <img src="images/question.gif" alt="info" class="icon-gif icon-gif--with-text" />
              <span>EVENT INFO</span>
            </a>
            <a
              href="challenges-submit"
              class="nav-tab"
              data-sound="menu"
              data-page="challenges-submit"
            >
              <img src="images/star_icon.gif" alt="star" class="icon-gif icon-gif--with-text" />
              <span>SUBMIT CHALLENGE</span>
            </a>
            <a href="leaderboard" class="nav-tab" data-sound="menu" data-page="leaderboard">
              <img src="images/trophy.gif" alt="trophy" class="icon-gif icon-gif--with-text" />
              <span>LEADERBOARD</span>
            </a>
            <a
              href="cocktail-judging"
              class="nav-tab"
              data-sound="menu"
              data-page="cocktail-judging"
            >
              <img
                src="images/cocktail_stirrer.gif"
                alt="cocktail"
                class="icon-gif icon-gif--with-text"
              />
              <span>JUDGE COCKTAILS</span>
            </a>
            <a
              href="admin-approvals"
              class="nav-tab"
              data-sound="menu"
              data-page="admin-approvals"
              data-admin-only
              style="display: none"
            >
              <img src="images/star_icon.gif" alt="admin" class="icon-gif icon-gif--with-text" />
              <span>üîê ADMIN</span>
            </a>
            <button class="nav-tab logout-btn">
              <img
                src="images/logout.gif"
                alt="logout"
                class="icon-gif icon-gif--lg icon-gif--with-text"
              />
              <span>LOGOUT</span>
            </button>
          </div>
        </div>
      </nav>

      <div class="section">
        <h2 class="text-shadow-light">üîê Pending Challenge Approvals</h2>
        <div id="pendingContainer">
          <div class="empty-state">Loading pending submissions...</div>
        </div>
      </div>

      <div class="section">
        <h2 class="text-shadow-light">‚úÖ Approved Challenges</h2>
        <div id="approvedContainer">
          <div class="empty-state">Loading approved challenges...</div>
        </div>
      </div>

      <div class="section">
        <details class="denied-challenges-details">
          <summary>
            <h2 class="text-shadow-light">‚úñÔ∏è Denied Challenges</h2>
          </summary>
          <div id="deniedContainer">
            <div class="empty-state">Loading denied challenges...</div>
          </div>
        </details>
      </div>
      <div class="section">
        <h2 class="text-shadow-light">üèÜ Contest/Competition Placements</h2>
        <div id="contestPlacementFormContainer"></div>
        <div id="contestPlacementTableContainer"></div>
      </div>
    </div>

    <!-- Challenge Details Modal -->
    <div id="detailsModal" class="challenge-modal">
      <div class="challenge-modal-overlay"></div>
      <div class="challenge-modal-content">
        <button id="closeDetailsModal" class="close-btn">‚úñÔ∏è</button>

        <h2 class="text-center rainbow-text">Challenge Details</h2>

        <div id="challengeDetails" class="challenge-details">
          <!-- Details will be populated here -->
        </div>
      </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignmentModal" class="challenge-modal">
      <div class="challenge-modal-overlay"></div>
      <div class="challenge-modal-content">
        <button id="closeAssignmentModal" class="close-btn">‚úñÔ∏è</button>

        <h2 class="text-center rainbow-text">Approve & Assign Challenge</h2>

        <form id="assignmentForm">
          <div id="assignmentChallengeInfo" class="form-info">
            <!-- Challenge info will be populated here -->
          </div>

          <div class="form-group">
            <label>Assign To</label>
            <div id="userCheckboxList" class="checkbox-list">
              <!-- User checkboxes will be populated here -->
            </div>
            <small>Check to assign, uncheck to unassign users for this challenge.</small>
          </div>

          <button type="submit" id="approveAssignBtn">‚úÖ SAVE ASSIGNMENTS</button>

          <div id="assignmentError" class="error-message"></div>
          <div id="assignmentSuccess" class="success-message"></div>
        </form>
      </div>
    </div>

    <script type="module">
      import { ContestPlacementForm } from "./js/components/contest-placement-form.js";
      import { ContestPlacementTable } from "./js/components/contest-placement-table.js";

      let currentEventId = null;
      const formContainer = document.getElementById("contestPlacementFormContainer");
      const tableContainer = document.getElementById("contestPlacementTableContainer");

      async function renderPlacementTable(eventId) {
        tableContainer.innerHTML = "";
        if (!eventId) return;
        const table = new ContestPlacementTable();
        await table.init(eventId);
        tableContainer.appendChild(table.element);
      }

      async function setupContestPlacementAdmin() {
        const form = new ContestPlacementForm({
          onSubmit: async (placement) => {
            // Upsert placement into Supabase (override if exists)
            const supabase =
              window.appState?.getSupabase?.() ||
              (await import("./js/app.js")).appState.getSupabase();
            const { error } = await supabase
              .from("competition_placements")
              .upsert([placement], { onConflict: ["event_id", "user_id"] });
            if (error) {
              alert("Error saving placement: " + error.message);
              return;
            }
            alert("Placement saved!");
            currentEventId = placement.event_id;
            await renderPlacementTable(currentEventId);
          },
        });
        await form.init();
        formContainer.appendChild(form.element);

        // Listen for event selection changes to update table
        form.element.querySelector('select[name="event"]').addEventListener("change", async (e) => {
          currentEventId = e.target.value;
          await renderPlacementTable(currentEventId);
        });
      }

      setupContestPlacementAdmin();
      import { appState } from "./js/app.js";
      import { initNavigation, navigationController } from "./js/components/navigation.js";
      import { AdminApprovalsPage } from "./js/pages/admin-approvals.js";

      async function init() {
        // Initialize app state (handles auth and navigation)
        const isAuthenticated = await appState.init();
        if (isAuthenticated) {
          // Initialize navigation (global nav, event listeners, etc)
          initNavigation();
          // Force update admin visibility after user is loaded
          navigationController.updateAdminVisibility();
          // Initialize the page logic
          const page = new AdminApprovalsPage();
          await page.init();
        }
      }
      init();
    </script>
  </body>
</html>
