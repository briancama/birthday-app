<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ Leaderboard - Birthday Challenge Zone üèÜ</title>  <link rel="icon" type="image/png" href="images/favicon.png">  <link rel="stylesheet" href="css/geocities.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>Leaderboard üèÜ</h1>
        <button class="secondary" id="signOutBtn">SIGN OUT</button>
      </div>
      <div class="nav-tabs">
        <a href="dashboard.html" class="nav-tab">DASHBOARD</a>
      background: #f8fafc;
      color: #475569;
      font-weight: 600;
    }
    .scoreboard-table tr:hover {
      background: #f8fafc;
    }
    .scoreboard-table tr.current-user {
      background: #eff6ff;
      font-weight: 600;
    }
    .scoreboard-table tr.current-user:hover {
      background: #dbeafe;
    }
    .rank-medal {
      font-size: 1.25rem;
      margin-right: 0.5rem;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 2rem;
    }
    .empty {
      text-align: center;
      color: #999;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>üèÜ Leaderboard</h1>
        <button class="secondary" id="signOutBtn">Sign Out</button>
      </div>
      <div class="nav-tabs">
        <a href="dashboard.html" class="nav-tab">DASHBOARD</a>
        <a href="leaderboard.html" class="nav-tab active">LEADERBOARD</a>
      </div>
    </div>

    <div class="section">
      <h2>üèÜ TOP PLAYERS üèÜ</h2>
      <div id="scoreboard" class="loading">Loading leaderboard...</div>
    </div>
  </div>

  <script type="module">
    import { SUPABASE_CONFIG } from './js/config.js'
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key)

    const userId = localStorage.getItem('user_id')
    const username = localStorage.getItem('username')

    // Redirect to login if not signed in
    if (!userId) {
      window.location.href = 'index.html'
    }

    // Sign out handler
    document.getElementById('signOutBtn').addEventListener('click', () => {
      localStorage.removeItem('user_id')
      localStorage.removeItem('username')
      window.location.href = 'index.html'
    })

    // Load full scoreboard
    async function loadScoreboard() {
      const container = document.getElementById('scoreboard')
      
      try {
        const { data, error } = await supabase
          .from('scoreboard')
          .select('*')

        if (error) throw error

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="empty">No scores yet.</div>'
          return
        }

        const getMedal = (rank) => {
          if (rank === 1) return 'ü•á'
          if (rank === 2) return 'ü•à'
          if (rank === 3) return 'ü•â'
          return ''
        }

        const getTrophyGif = (rank) => {
          if (rank <= 3) return '<img src="images/trophy.gif" class="trophy-gif" alt="Trophy" onerror="this.style.display=\'none\'">'
          return ''
        }

        container.innerHTML = `
          <table class="scoreboard-table">
            <thead>
              <tr>
                <th>RANK</th>
                <th>PLAYER</th>
                <th>ASSIGNED</th>
                <th>COMPETITION</th>
                <th>TOTAL POINTS</th>
              </tr>
            </thead>
            <tbody>
              ${data.map((row, idx) => {
                const rank = idx + 1
                const isCurrentUser = row.user_id === userId
                return `
                  <tr class="${isCurrentUser ? 'current-user' : ''}">
                    <td>
                      ${getMedal(rank) ? `<span class="rank-medal">${getMedal(rank)}</span>` : ''}
                      #${rank}
                      ${getTrophyGif(rank)}
                    </td>
                    <td>${row.display_name || row.username}${isCurrentUser ? ' (YOU!)' : ''}</td>
                    <td>${row.assigned_points}</td>
                    <td>${row.competition_points}</td>
                    <td><strong>${row.total_points}</strong></td>
                  </tr>
                `
              }).join('')}
            </tbody>
          </table>
        `

      } catch (err) {
        container.innerHTML = `<div class="empty">Error loading leaderboard: ${err.message}</div>`
      }
    }

    // Initial load
    loadScoreboard()

    // Refresh leaderboard every 10 seconds
    setInterval(loadScoreboard, 10000)
  </script>
</body>
</html>
