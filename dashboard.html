<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Birthday App</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .header {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    h1 { color: #333; font-size: 1.75rem; }
    .username { color: #667eea; }
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 0;
    }
    .nav-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      color: #666;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    .nav-tab:hover {
      background: #f8fafc;
      color: #333;
    }
    .nav-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: transparent;
    }
    button {
      padding: 0.5rem 1rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #5568d3; }
    button.secondary {
      background: #e53e3e;
    }
    button.secondary:hover {
      background: #c53030;
    }
    .section {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    h2 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    .challenge-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .challenge-card {
      border: 2px solid #e2e8f0;
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
    }
    .challenge-card.locked {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f8fafc;
    }
    .challenge-card.unrevealed {
      cursor: pointer;
      border-color: #cbd5e1;
    }
    .challenge-card.unrevealed:hover {
      border-color: #667eea;
      background: #f8fafc;
    }
    .challenge-card.revealed {
      border-color: #667eea;
      background: #eff6ff;
    }
    .challenge-card.completed.success {
      background: #f0fdf4;
      border-color: #86efac;
    }
    .challenge-card.completed.failure {
      background: #fef2f2;
      border-color: #fca5a5;
    }
    .challenge-info h3 {
      color: #333;
      font-size: 1.125rem;
      margin-bottom: 0.25rem;
    }
    .challenge-info p {
      color: #666;
      font-size: 0.875rem;
    }
    .challenge-details {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid #e2e8f0;
    }
    .challenge-actions {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    .challenge-card button {
      padding: 0.5rem 1rem;
      white-space: nowrap;
      font-size: 0.875rem;
    }
    .challenge-card button.success-btn {
      background: #22c55e;
    }
    .challenge-card button.success-btn:hover {
      background: #16a34a;
    }
    .challenge-card button.failure-btn {
      background: #ef4444;
    }
    .challenge-card button.failure-btn:hover {
      background: #dc2626;
    }
    .outcome-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.875rem;
    }
    .outcome-badge.success {
      background: #22c55e;
      color: white;
    }
    .outcome-badge.failure {
      background: #ef4444;
      color: white;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 2rem;
    }
    .empty {
      text-align: center;
      color: #999;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>Welcome, <span class="username" id="displayName">...</span>! üéâ</h1>
        <button class="secondary" id="signOutBtn">Sign Out</button>
      </div>
      <div class="nav-tabs">
        <a href="dashboard.html" class="nav-tab active">Dashboard</a>
        <a href="leaderboard.html" class="nav-tab">Leaderboard</a>
      </div>
    </div>

    <div class="section">
      <h2>Your Stats</h2>
      <div id="personalStats" class="loading">Loading your stats...</div>
    </div>

    <div class="section">
      <h2>Your Challenges</h2>
      <div id="challengesList" class="loading">Loading challenges...</div>
    </div>
  </div>

  <script type="module">
    const SUPABASE_URL = 'https://pvvkkcqxkwlzfwlladoe.supabase.co'
    const SUPABASE_KEY = 'sb_publishable_INEqArDABXzb2p2YjiwhJA_jlj_4Q2y'

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    const userId = localStorage.getItem('user_id')
    const username = localStorage.getItem('username')

    // Redirect to login if not signed in
    if (!userId) {
      window.location.href = 'index.html'
    }

    // Load and display user's display_name
    async function loadUserProfile() {
      const { data, error } = await supabase
        .from('users')
        .select('display_name')
        .eq('id', userId)
        .single()
      
      if (!error && data) {
        document.getElementById('displayName').textContent = data.display_name || username
      } else {
        document.getElementById('displayName').textContent = username
      }
    }

    loadUserProfile()

    // Sign out handler
    document.getElementById('signOutBtn').addEventListener('click', () => {
      localStorage.removeItem('user_id')
      localStorage.removeItem('username')
      window.location.href = 'index.html'
    })

    // Track revealed challenge
    let revealedChallengeId = null

    // Load user's assigned challenges
    async function loadChallenges() {
      const container = document.getElementById('challengesList')
      
      try {
        const { data, error } = await supabase
          .from('assignments')
          .select(`
            id,
            completed_at,
            outcome,
            challenges (id, title, description, brian_mode)
          `)
          .eq('user_id', userId)
          .order('assigned_at', { ascending: true })

        if (error) throw error

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="empty">No challenges assigned yet.</div>'
          return
        }

        container.innerHTML = ''
        container.className = 'challenge-list'

        // Find first incomplete challenge
        const firstIncompleteIndex = data.findIndex(a => !a.completed_at)

        data.forEach((assignment, index) => {
          const isCompleted = !!assignment.completed_at
          const outcome = assignment.outcome
          const brianMode = assignment.challenges.brian_mode
          const isRevealed = revealedChallengeId === assignment.id
          const canReveal = !isCompleted && (firstIncompleteIndex === index || isRevealed)
          const isLocked = !isCompleted && firstIncompleteIndex < index && !isRevealed
          
          const card = document.createElement('div')
          let cardClass = 'challenge-card'
          if (isCompleted) {
            cardClass += ` completed ${outcome}`
          } else if (isLocked) {
            cardClass += ' locked'
          } else if (isRevealed) {
            cardClass += ' revealed'
          } else if (canReveal) {
            cardClass += ' unrevealed'
          }
          card.className = cardClass
          
          let actionsHTML = ''
          if (!isCompleted && isRevealed) {
            actionsHTML = `
              <div class="challenge-actions">
                <button class="success-btn" data-id="${assignment.id}" data-outcome="success">
                  üéâ Success
                </button>
                <button class="failure-btn" data-id="${assignment.id}" data-outcome="failure">
                  ‚ùå Failure
                </button>
              </div>
            `
          } else if (isCompleted) {
            actionsHTML = `
              <span class="outcome-badge ${outcome}">
                ${outcome === 'success' ? '‚úì Success' : '‚úó Failure'}
              </span>
            `
          } else if (!isCompleted && canReveal && !isRevealed) {
            actionsHTML = `<span style="color: #667eea; font-weight: 600;">Click to reveal ‚Üí</span>`
          } else if (isLocked) {
            actionsHTML = `<span style="color: #94a3b8;">üîí Locked</span>`
          }
          
          const brianBadge = brianMode ? `<span style="background: #fbbf24; color: #78350f; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">${brianMode === 'vs' ? '‚öîÔ∏è vs Brian' : 'ü§ù with Brian'}</span>` : ''
          
          // Show generic title unless completed or revealed
          const displayTitle = (isCompleted || isRevealed) 
            ? `${assignment.challenges.title}${brianBadge}` 
            : `Challenge ${index + 1}`
          
          const displayDescription = (isCompleted || isRevealed)
            ? `<p>${assignment.challenges.description || 'No description'}</p>`
            : ''
          
          card.innerHTML = `
            <div class="challenge-info" style="flex: 1;">
              <h3>${displayTitle}</h3>
              ${displayDescription}
            </div>
            ${actionsHTML}
          `
          
          // Click to reveal for unrevealed challenges
          if (!isCompleted && canReveal && !isRevealed) {
            card.style.cursor = 'pointer'
            card.addEventListener('click', () => {
              revealedChallengeId = assignment.id
              loadChallenges()
            })
          }
          
          if (isRevealed) {
            card.querySelectorAll('button').forEach(btn => {
              btn.addEventListener('click', () => {
                const outcome = btn.dataset.outcome
                markComplete(assignment.id, assignment.challenges.id, outcome, brianMode)
              })
            })
          }
          
          container.appendChild(card)
        })

      } catch (err) {
        container.innerHTML = `<div class="empty">Error loading challenges: ${err.message}</div>`
      }
    }

    // Mark challenge as complete
    async function markComplete(assignmentId, challengeId, outcome, brianMode) {
      try {
        const now = new Date().toISOString()
        
        // Update user's assignment with outcome
        const { error: updateError } = await supabase
          .from('assignments')
          .update({ completed_at: now, outcome: outcome })
          .eq('id', assignmentId)

        if (updateError) throw updateError

        // If it's a Brian challenge, auto-create brianc's assignment
        if (brianMode) {
          // Get brianc's user_id
          const { data: briancUser, error: briancError } = await supabase
            .from('users')
            .select('id')
            .eq('username', 'brianc')
            .single()
          
          if (briancError) throw briancError

          let briancOutcome
          if (brianMode === 'with') {
            // Collaborative: both get same outcome
            briancOutcome = outcome
          } else if (brianMode === 'vs') {
            // Competitive: opposite outcome
            briancOutcome = outcome === 'success' ? 'failure' : 'success'
          }

          // Create brianc's assignment
          const { error: briancAssignError } = await supabase
            .from('assignments')
            .insert([{
              user_id: briancUser.id,
              challenge_id: challengeId,
              completed_at: now,
              outcome: briancOutcome
            }])
          
          if (briancAssignError) throw briancAssignError
        }

        // Reset revealed challenge
        revealedChallengeId = null

        // Reload challenges and personal stats
        await Promise.all([loadChallenges(), loadPersonalStats()])

      } catch (err) {
        alert('Failed to mark complete: ' + err.message)
        console.error('Error:', err)
      }
    }

    // Load personal stats (user's position and points)
    async function loadPersonalStats() {
      const container = document.getElementById('personalStats')
      
      try {
        const { data, error } = await supabase
          .from('scoreboard')
          .select('*')

        if (error) throw error

        const userStats = data?.find(row => row.user_id === userId)
        const rank = data?.findIndex(row => row.user_id === userId) + 1

        if (!userStats) {
          container.innerHTML = '<div class="empty">No stats yet. Complete some challenges!</div>'
          return
        }

        container.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
              <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">Your Rank</div>
              <div style="font-size: 2rem; font-weight: 700; color: #667eea;">#${rank}</div>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
              <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">Total Points</div>
              <div style="font-size: 2rem; font-weight: 700; color: #667eea;">${userStats.total_points}</div>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
              <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">Assigned Complete</div>
              <div style="font-size: 2rem; font-weight: 700; color: #22c55e;">${userStats.assigned_completed}</div>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
              <div style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">Competition Points</div>
              <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">${userStats.competition_points}</div>
            </div>
          </div>
        `

      } catch (err) {
        container.innerHTML = `<div class="empty">Error loading stats: ${err.message}</div>`
      }
    }

    // Initial load
    loadPersonalStats()
    loadChallenges()

    // Refresh stats every 10 seconds
    setInterval(loadPersonalStats, 10000)
  </script>
</body>
</html>